{% extends "layouts/main.html" %}

{% block title %}Article - EcoVision{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main/article.css') }}" />

<script>
  tinymce.init({
    selector: 'textarea#content',
    plugins: 'anchor autolink image link lists media searchreplace table wordcount',
    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | align lineheight | tinycomments | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
    mergetags_list: [
      { value: 'First.Name', title: 'First Name' },
      { value: 'Email', title: 'Email' },
    ]
  });
</script>



{% endblock %}


{% block content %}
<div class="container article-page">
  <div class="article">
    <p>{{ article.date.strftime('%B %d, %Y') }}</p>

    {% if current_user.is_authenticated == true and (current_user.type == "admin" or current_user.type == "author") %}
    <div class="delete-button">
      <a href="{{url_for('main.news', deletepost=article.postid)}}" class="btn btn-danger">Delete
        Current Post</a>
    </div>
    <form method="POST">
      {{ form.hidden_tag() }}
      <br>
      <p>
        Cover image on the news page
        <br>
        {{ form.image_view_onNews(value=article.image_name) }}
        <input type="file" id="imageInput" accept=".jpg,.jpeg,.png,.webp">
        <img src="" alt="" id="imagePreview">
      </p>

      <p>
        {{ form.title(value=article.title) }}
      </p>

      <p>
        <textarea name="content" id="content" cols="30" rows="30" required
          placeholder="Content">{{article.content}}</textarea>
      </p>

      <div class="form-footer">

        <div class="status-message" style="display: inline-block;">
          {% if status_message != none %}{{status_message}}{% endif %}</div>
        <input type="submit" value="Save">
      </div>
    </form>
    {% else %}

    <div>
      <h2>{{ article.title }}</h2>
      <div class='postid_{{ article.postid }} post-content'>
        {{ article.content | safe }}
      </div>
    </div>

    {% endif %}
  </div>
</div>

<script>
  $("#image_view_onNews").css("pointerEvents", "none").css("opacity", "0.5");
  $(document).ready(function () {
    var socket = io();

    $('#imageInput').on('change', function () {
      var file = $('#imageInput').get(0).files[0];
      var reader = new FileReader();

      reader.onload = function () {
        var dataURL = reader.result;
        var chunkSize = 5000; // Size of each chunk
        var start = 0;

        var index = 0;  // Initialize an index counter

        while (start < dataURL.length) {
          var end = start + chunkSize;
          var chunk = dataURL.slice(start, end);
          socket.emit('upload_image', { image: chunk, index: index, final: end >= dataURL.length });
          start = end;
          index++;  // Increment the index counter for each chunk
        }
      };

      reader.onerror = function () {
        console.log('Error occurred while reading the file');
      };

      reader.readAsDataURL(file);
    });

    socket.on('image_response', function (msg) {
      console.log("image_response", msg)
      /* $('#imagePreview').attr('src', msg.image); */
      $('#image_view_onNews').attr("value", msg.image_name)
    });
  });
</script>
{% endblock %}